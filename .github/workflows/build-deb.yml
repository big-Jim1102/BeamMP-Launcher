name: Build .deb Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            dpkg-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            zlib1g-dev
      
      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.sh
      
      - name: Build .deb package
        run: |
          chmod +x build-deb.sh
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ./build-deb.sh "${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/v//')
            ./build-deb.sh "$VERSION"
          fi
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: beammp-launcher-deb
          path: |
            build-deb/*.deb
            *.deb
      
      - name: Find .deb file
        if: startsWith(github.ref, 'refs/tags/')
        id: find-deb
        run: |
          echo "Searching for .deb files..."
          DEB_FILE=$(find . -name "*.deb" -type f | head -n 1)
          if [ -z "$DEB_FILE" ]; then
            echo "ERROR: No .deb file found!"
            find . -name "*.deb" -type f
            exit 1
          fi
          echo "Found .deb file: $DEB_FILE"
          echo "file=$DEB_FILE" >> $GITHUB_OUTPUT
          ls -lh "$DEB_FILE"
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create-release
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const releaseName = `Release ${tagName}`;
            const releaseBody = `## BeamMP Launcher ${tagName}
            
            Linux .deb package for BeamMP Launcher.
            
            ### Installation
            \`\`\`bash
            sudo dpkg -i beammp-launcher_*.deb
            sudo apt-get install -f
            \`\`\`
            
            ### Uninstallation
            \`\`\`bash
            sudo apt-get remove beammp-launcher
            \`\`\`
            
            Or to remove with configuration files:
            \`\`\`bash
            sudo apt-get purge beammp-launcher
            \`\`\``;
            
            const response = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseName,
              body: releaseBody,
              draft: false,
              prerelease: false
            });
            
            console.log(`Release created: ${response.data.id}`);
            core.setOutput('release_id', response.data.id);
            core.setOutput('upload_url', response.data.upload_url);
      
      - name: Upload .deb to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const debFile = '${{ steps.find-deb.outputs.file }}';
            
            if (!fs.existsSync(debFile)) {
              throw new Error(`.deb file not found: ${debFile}`);
            }
            
            const fileName = path.basename(debFile);
            const fileSize = fs.statSync(debFile).size;
            const fileContent = fs.readFileSync(debFile);
            
            console.log(`Uploading ${fileName} (${fileSize} bytes)...`);
            
            const tagName = context.ref.replace('refs/tags/', '');
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tagName
            });
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: fileName,
              data: fileContent,
              headers: {
                'content-type': 'application/vnd.debian.binary-package',
                'content-length': fileSize
              }
            });
            
            console.log(`Successfully uploaded ${fileName} to release ${tagName}`);



